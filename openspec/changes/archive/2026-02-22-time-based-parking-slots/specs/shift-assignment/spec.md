# shift-assignment Specification (delta)

## Changes

このファイルは `shift-assignment` 機能の差分仕様である。
既存仕様（`openspec/specs/shift-assignment/spec.md`）の「駐車場をアサイン時に自動割り当てする」Requirementを以下の定義に**置き換える**。データや既存アサインへの後方互換性への影響はなく、動作ロジックのみが変更される。

---

### Requirement: 駐車場をアサイン時に自動割り当てする（時間帯ベース）
システムは、駐車場利用フラグがONのスタッフがアサインされた際、以下の優先順位で駐車場枠を割り当てなければならない（SHALL）。

1. 同一スタッフが同一日にすでに駐車場枠が割り当てられているアサインが存在する場合、その既存の枠を再利用する（時間帯にかかわらず）
2. 既存の割り当てがない場合、**同一日・同一時間帯**に他スタッフが使用していない空き枠を、種別A優先・同種別内では番号昇順（A1, A2, ...）で新規割り当てする
3. 空き枠がない場合は割り当てなしとする

時間帯とは「午前（morning）・午後（afternoon）・夕方（evening）」の3区分を指す（`shift-slot-config` 仕様に準拠）。異なる時間帯のスタッフ間では同一の駐車場枠を共有できる。

バルクアサイン（自動生成によるアサイン一括適用）においても、同一のロジック（時間帯ベースの空き枠チェックおよび同一スタッフ同一日の既存枠再利用）を適用する。

#### Scenario: AMのみのスタッフとPMのみのスタッフが同一枠を共有できる
- **GIVEN** 駐車場利用フラグがONのスタッフAが午前にアサインされており、枠A1が割り当てられている
- **WHEN** 駐車場利用フラグがONの別スタッフBを同一日の午後にアサインする
- **THEN** スタッフBにも枠A1が割り当てられる（午後の時間帯にA1を使用するスタッフがいないため）

#### Scenario: 同一時間帯にすでに枠が使用されている場合は別の枠が割り当てられる
- **GIVEN** 駐車場利用フラグがONのスタッフAが午前にアサインされており、枠A1が割り当てられている
- **WHEN** 駐車場利用フラグがONの別スタッフBを同一日の午前にアサインしようとする
- **THEN** スタッフBにはA1ではなくA2（次の空き枠）が割り当てられる

#### Scenario: 夕方のスタッフと午前のスタッフが同一枠を共有できる
- **GIVEN** 駐車場利用フラグがONのスタッフAが午前にアサインされており、枠A1が割り当てられている
- **WHEN** 駐車場利用フラグがONの別スタッフBを同一日の夕方にアサインする
- **THEN** スタッフBにも枠A1が割り当てられる（夕方の時間帯にA1を使用するスタッフがいないため）

#### Scenario: 駐車場枠が空いている場合に自動割り当てされる
- **GIVEN** 同一日・同一時間帯にアサイン済みのスタッフが存在しない（A1〜A4・B1がすべて空き）
- **WHEN** 駐車場利用フラグがONのスタッフをアサインする
- **THEN** 同一日・同一時間帯に空いている駐車場枠（A優先、次にB）が自動的に割り当てられる

#### Scenario: 同一時間帯の全枠が満杯の場合は割り当てなしになる
- **GIVEN** A1・A2・A3・A4・B1がすべて同一日・同一時間帯の別スタッフに割り当て済みである
- **WHEN** 駐車場利用フラグがONの別スタッフを同一日・同一時間帯にアサインしようとする
- **THEN** 駐車場番号なしでアサインが保存される

#### Scenario: 同一スタッフが同一日に複数時間帯でアサインされる場合は既存枠を再利用する
- **GIVEN** 駐車場利用フラグがONのスタッフAが午前にアサインされており、枠A1が割り当てられている（午後の時間帯には別スタッフがA1を使用中であっても）
- **WHEN** 同一スタッフAをさらに午後にアサインする
- **THEN** 新たに駐車場枠を消費せず、既存のアサインと同じ枠A1が割り当てられる（同一スタッフの連続利用のため競合は発生しない）
