# help-staff-alert Delta Spec（ヘルプスタッフ稼働可能状況の考慮）

この仕様は `openspec/specs/help-staff-alert/spec.md` の拡張仕様である。

**変更する既存要件:**
- `Requirement: 必要人数を下回る日・時間帯を自動検出する` → ヘルプスタッフの稼働可能状況を加味した不足判定に変更
- `Requirement: 不足人数を表示する` → ヘルプスタッフを考慮した不足人数の算出に変更

**既存要件への影響（変更なし）:**
- `Requirement: ヘルプスタッフの必要有無をシフト表に表示する` → 表示条件自体（不足>0のときアラート表示）は変更しない。不足判定ロジックの変更により、ヘルプスタッフで補える場合はアラートが表示されなくなるが、これは判定ロジック変更の自然な結果であり、表示仕様は既存のまま維持する

---

## 変更する要件

### Requirement: 必要人数を下回る日・時間帯を自動検出する（ヘルプスタッフ考慮）

システムは、各日・各時間帯において、通常スタッフ**およびヘルプスタッフ**の出勤可能人数の合計が必要人数を下回る状況を自動検出しなければならない（SHALL）。

**変更前の判定ロジック:**
```
不足 = 必要人数 - 出勤可能な通常スタッフ数
```

**変更後の判定ロジック:**
```
不足 = 必要人数 - (出勤可能な通常スタッフ数 + 稼働可能なヘルプスタッフ数)
```

「出勤可能な通常スタッフ数」の定義:
- その日に希望休が登録されていない
- その時間帯が出勤可能時間帯（`availableSlots`）に含まれている

ヘルプスタッフが「稼働可能」と判定される条件:
1. `availableDates` にその日付が含まれている
2. `availableSlots` にその時間帯が含まれている

#### Scenario: 稼働可能なヘルプスタッフがいる場合、不足人数から差し引かれる

- **GIVEN** ある日の午前の必要人数が3人
- **AND** 出勤可能な通常スタッフが1人（希望休なし・午前対応可能）
- **AND** その日の `availableDates` に含まれ、`availableSlots` に午前を持つヘルプスタッフが1人いる
- **WHEN** 不足判定を実行する
- **THEN** 不足人数は1人（3 - 1 - 1 = 1）と表示される

#### Scenario: ヘルプスタッフだけで不足を補える場合、アラートは表示されない

- **GIVEN** ある日の午前の必要人数が2人
- **AND** 出勤可能な通常スタッフが1人
- **AND** その日の午前に稼働可能なヘルプスタッフが1人いる
- **WHEN** 不足判定を実行する
- **THEN** 不足人数は0（2 - 1 - 1 = 0）であり、アラートは表示されない

#### Scenario: ヘルプスタッフでも不足する場合、残りの不足人数がアラートに表示される

- **GIVEN** ある日の午前の必要人数が5人
- **AND** 出勤可能な通常スタッフが2人
- **AND** その日の午前に稼働可能なヘルプスタッフが1人いる
- **WHEN** 不足判定を実行する
- **THEN** 不足人数は2人（5 - 2 - 1 = 2）とアラートに表示される

#### Scenario: 稼働可能日付に含まれないヘルプスタッフはカウントされない

- **GIVEN** ある日の午前の必要人数が3人
- **AND** 出勤可能な通常スタッフが1人
- **AND** ヘルプスタッフが2人登録されているが、その日の `availableDates` に含まれるのは1人のみ（両者とも午前対応可能）
- **WHEN** 不足判定を実行する
- **THEN** 不足人数は1人（3 - 1 - 1 = 1）と表示される（稼働不可能なヘルプスタッフはカウントしない）

#### Scenario: ヘルプスタッフの出勤可能時間帯でない場合はカウントされない

- **GIVEN** ある日の夕方の必要人数が2人
- **AND** 出勤可能な通常スタッフが0人（希望休なし・夕方対応可能なスタッフが0人）
- **AND** その日の `availableDates` に含まれるヘルプスタッフが1人いるが、`availableSlots` に「夕方」が含まれていない
- **WHEN** 不足判定を実行する
- **THEN** 不足人数は2人（2 - 0 - 0 = 2）と表示される

---

### Requirement: 不足人数を表示する（ヘルプスタッフ考慮）

システムは、人数不足が検出された日・時間帯において、ヘルプスタッフを含めた出勤可能人数で算出した不足人数（必要人数 − 出勤可能通常スタッフ数 − 稼働可能ヘルプスタッフ数）を表示できなければならない（SHALL）。

#### Scenario: ヘルプスタッフ考慮後の不足人数が正しく表示される

- **GIVEN** ある日の午前の必要人数が4人
- **AND** 出勤可能な通常スタッフが1人
- **AND** その日の午前に稼働可能なヘルプスタッフが1人いる
- **WHEN** 不足判定を実行する
- **THEN** 不足人数は2人（4 - 1 - 1 = 2）としてシフト表に表示される
