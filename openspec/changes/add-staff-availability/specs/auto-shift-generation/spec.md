# auto-shift-generation Delta Spec（ヘルプスタッフの自動アサイン統合）

この仕様は `openspec/specs/auto-shift-generation/spec.md` の拡張仕様である。

**既存要件への影響:**
- 既存の強制制約（希望休・出勤可能時間帯・週上限・駐車場・全時間帯アサイン・必要人数上限）はすべて通常スタッフに対して維持する
- ヘルプスタッフ固有の制約を追加する

---

## 追加・変更する要件

### Requirement: ヘルプスタッフを自動生成の割り当て候補に含める

システムは、自動シフト生成時にヘルプスタッフを通常スタッフとともに割り当て候補として扱わなければならない（SHALL）。ただし、通常スタッフを優先的にアサインし、ヘルプスタッフのアサイン数が最小となるよう全体最適化しなければならない（SHALL）。

**最適化方針:**
- 候補スタッフのソート順: 通常スタッフ（週アサイン数の少ない順）→ ヘルプスタッフ（期間内アサイン数の少ない順）
- 通常スタッフだけで各時間帯の必要人数を充足できる場合、ヘルプスタッフはアサインしない
- 通常スタッフだけでは不足する場合にのみ、ヘルプスタッフを不足分だけアサインする

#### Scenario: 通常スタッフで充足可能な場合、ヘルプスタッフはアサインされない

- **GIVEN** ある日の午前の必要人数が2人
- **AND** 通常スタッフが3人利用可能である
- **AND** ヘルプスタッフが1人稼働可能である
- **WHEN** 自動生成を実行する
- **THEN** 通常スタッフのみがアサインされ、ヘルプスタッフはアサインされない

#### Scenario: 通常スタッフだけでは不足する場合、ヘルプスタッフがアサインされる

- **GIVEN** ある日の午前の必要人数が3人
- **AND** 通常スタッフが1人しか利用可能でない
- **AND** ヘルプスタッフが2人稼働可能である
- **WHEN** 自動生成を実行する
- **THEN** 通常スタッフ1人とヘルプスタッフ2人がアサインされる

#### Scenario: 複数ヘルプスタッフがいる場合、アサイン数の少ないヘルプスタッフが優先される

- **GIVEN** ヘルプスタッフAの期間内アサイン数が2日
- **AND** ヘルプスタッフBの期間内アサイン数が0日
- **WHEN** ヘルプスタッフを1人アサインする必要がある
- **THEN** ヘルプスタッフB（アサイン数0日）が優先的にアサインされる

---

### Requirement: ヘルプスタッフは稼働可能日付のみにアサインする（強制制約）

システムは、自動生成時にヘルプスタッフの `availableDates` に含まれない日付へのアサインを行ってはならない（SHALL NOT）。

#### Scenario: 稼働可能日付にはアサインされる

- **GIVEN** ヘルプスタッフAの `availableDates` に date1 が含まれている
- **WHEN** date1 の自動生成でヘルプスタッフAが候補になる
- **THEN** ヘルプスタッフAはdate1にアサイン可能である

#### Scenario: 稼働可能日付に含まれない日にはアサインされない

- **GIVEN** ヘルプスタッフAの `availableDates` に date2 が含まれていない
- **WHEN** date2 の自動生成でアサイン候補を決定する
- **THEN** ヘルプスタッフAはdate2のアサイン候補から除外される

---

### Requirement: ヘルプスタッフに既存の強制制約を適用する（一部除外）

システムは、ヘルプスタッフに対して以下の強制制約を適用しなければならない（SHALL）:

- **出勤可能時間帯制約**: `availableSlots` に含まれない時間帯にはアサインしない
- **駐車場制約**: `usesParking=true` の場合、駐車場に空きがなければアサインしない
- **全時間帯アサイン制約**: 出勤日には利用可能な全時間帯（必要人数>0）にアサインする
- **必要人数上限制約**: 各時間帯の必要人数を超えるアサインをしない（例外あり：全時間帯アサインにより超過が避けられない場合は許容）

以下の制約はヘルプスタッフには適用しない:
- **週上限出勤回数**: ヘルプスタッフは `availableDates` で出勤日を制御するため適用しない
- **希望休**: ヘルプスタッフは希望休エンティティを持たないため適用しない

#### Scenario: ヘルプスタッフの出勤可能時間帯のみにアサインされる

- **GIVEN** ヘルプスタッフAの出勤可能時間帯が「午前・午後」のみである
- **WHEN** 自動生成でヘルプスタッフAをアサインする
- **THEN** 午前と午後にアサインされ、夕方にはアサインされない

#### Scenario: ヘルプスタッフも出勤日には全時間帯にアサインされる

- **GIVEN** ヘルプスタッフAの出勤可能時間帯が「午前・午後」で、両方とも必要人数>0である
- **WHEN** 自動生成でヘルプスタッフAをある日に出勤させると決定する
- **THEN** ヘルプスタッフAは午前と午後の両方にアサインされる

#### Scenario: ヘルプスタッフには週上限を適用しない

- **GIVEN** ヘルプスタッフAの `availableDates` に同一週内の5日が含まれている
- **WHEN** 自動生成を実行し、5日すべてでヘルプスタッフAが必要である
- **THEN** ヘルプスタッフAは5日すべてにアサインされる（週上限による制限なし）

