# preferred-day-off Delta Spec（希望休一括登録）

この仕様は `openspec/specs/preferred-day-off/spec.md` の拡張仕様である。既存の要件（単一登録・削除・一覧確認）はすべて維持し、本ファイルに記述する要件を追加・変更する。

## 追加・変更する要件

### Requirement: カレンダーUIで複数の日付をまとめて希望休として一括登録できる

システムは、スタッフを1人選択した上でカレンダーUIから複数の日付をトグル選択し、一括で希望休を登録できなければならない（SHALL）。

UIフロー（シフト期間設定済みの場合）:
1. スタッフをセレクトボックスで選択する
2. スタッフ選択後、シフト期間を含む月のカレンダーが表示される
3. カレンダー上の日付をタップ/クリックして選択（ハイライト）・解除をトグルする
4. 1つ以上の日付を選択した状態で「一括登録」ボタンを押す

カレンダー表示のルール:
- シフト期間外の日付はグレーアウトして選択不可とする（タップしても選択されない）
- すでに希望休として登録済みの日付は、選択前から区別可能な表示（例: 背景色やマーク）で示す。登録済みの日付もトグル選択可能だが、一括登録時にスキップされる
- 選択中（未登録・選択済み）の日付はハイライト表示する
- 期間が複数月にまたがる場合は「前月」「翌月」ボタンでページ送りする。初期表示はシフト期間の開始月とする
- 「一括登録」ボタンのラベルは「一括登録」とし、日付未選択時も活性のまま表示する（クリック時にエラーメッセージを表示する）
- 一括登録の結果メッセージは、次に日付を選択したとき、またはスタッフを切り替えたときに消える

> **注記**: 一括登録（`addDayOffs`）における重複スキップの挙動は、既存の単一登録（`addDayOff`）の「重複エラー表示」とは異なる。単一登録の挙動は変更しない。一括登録では、複数件の中に重複が含まれる場合はエラーとせずスキップし、新規分のみ登録する。

#### Scenario: シフト期間設定済みの場合、スタッフ選択後にカレンダーが表示される

- **GIVEN** シフト期間が設定されている
- **AND** スタッフが選択されている
- **WHEN** ユーザーが希望休登録フォームを参照する
- **THEN** シフト期間の開始月からカレンダーが表示される
- **AND** シフト期間外の日付はグレーアウトして選択不可で表示される
- **AND** 登録済みの希望休日付は区別可能なスタイルで表示される

#### Scenario: スタッフ未選択の場合はカレンダーが表示されない

- **GIVEN** シフト期間が設定されている
- **AND** スタッフが選択されていない
- **WHEN** ユーザーが希望休登録フォームを参照する
- **THEN** カレンダーは表示されない

#### Scenario: カレンダー上の日付をタップして選択・解除できる

- **GIVEN** スタッフが選択されており、カレンダーが表示されている
- **WHEN** ユーザーがシフト期間内の未選択の日付をタップする
- **THEN** その日付が選択状態（ハイライト）になる
- **WHEN** ユーザーが選択済みの日付を再度タップする
- **THEN** その日付の選択が解除される

#### Scenario: 複数日付を選択して一括登録できる

- **GIVEN** スタッフが選択されており、1つ以上の日付が選択されている
- **WHEN** ユーザーが「一括登録」ボタンを押す
- **THEN** 選択されたスタッフのすべての選択日付が希望休としてLocalStorageに保存される
- **AND** カレンダー上の選択状態がすべて解除される（スタッフの選択は維持される）
- **AND** 登録済みになった日付はカレンダー上で登録済みスタイルに更新される

#### Scenario: 重複する日付は登録をスキップし、新規分のみ登録する

- **GIVEN** 選択した日付の一部がすでに登録済みである
- **WHEN** ユーザーが一括登録を実行する
- **THEN** 未登録の日付のみが新規登録される
- **AND** 登録済みの日付はスキップされる（エラーにはならない）
- **AND** フォーム上部に「X件を登録しました（Y件は重複のためスキップ）」というメッセージが表示される

#### Scenario: シフト期間外の日付はタップしても選択されない

- **GIVEN** カレンダーが表示されており、シフト期間外の日付がある
- **WHEN** ユーザーがシフト期間外の日付をタップする
- **THEN** その日付は選択されない（選択状態に変化しない）

#### Scenario: 日付が1つも選択されていない場合は登録できない

- **GIVEN** スタッフが選択されているが、カレンダー上で日付が1つも選択されていない
- **WHEN** ユーザーが「一括登録」ボタンを押す
- **THEN** 「日付を1つ以上選択してください」というエラーメッセージが表示され、登録は行われない

#### Scenario: スタッフを切り替えると選択中の日付がリセットされる

- **GIVEN** スタッフAが選択されており、複数の日付が選択されている
- **WHEN** ユーザーがスタッフBに切り替える
- **THEN** 選択中の日付はすべて解除される
- **AND** スタッフBの登録済み希望休がカレンダーに反映される

---

### Requirement: シフト期間未設定時は単一日付入力にフォールバックする

シフト期間が設定されていない場合、従来の単一日付入力（`<input type="date">`）による1件登録UIを提供しなければならない（SHALL）。

#### Scenario: シフト期間未設定時は日付入力フィールドが表示される

- **GIVEN** シフト期間が設定されていない
- **WHEN** ユーザーが希望休登録フォームを開く
- **THEN** カレンダーUIではなく、日付入力フィールド（`<input type="date">`）が表示される
- **AND** スタッフと日付を選択して1件ずつ登録できる（既存仕様の挙動を維持する）

---

## 変更する実装（フック）

### `useDayOffs` フックへの `addDayOffs` 追加

`useDayOffs` フックは複数件を一括登録する `addDayOffs` 関数を提供しなければならない（SHALL）。

```ts
addDayOffs(staffId: string, dates: string[]): { added: number; skipped: number }
```

- `dates` の各要素は `YYYY-MM-DD` 形式の文字列とする（既存の `addDayOff` と同様）。UIレイヤーでフォーマットを保証するため、フック内バリデーションは行わない
- `added`: 新規登録された件数（重複なし）
- `skipped`: すでに登録済みのためスキップされた件数
- LocalStorageへの書き込みは1回の `setDayOffs` で一括更新し、部分書き込みは発生しない（同期関数）
- 既存の `addDayOff`（単数形）は変更しない

#### Scenario: addDayOffs が新規件数とスキップ件数を返す

- **GIVEN** あるスタッフに対して3日分の日付を渡す（うち1日は登録済み）
- **WHEN** `addDayOffs(staffId, [date1, date2, date3])` を呼ぶ
- **THEN** `{ added: 2, skipped: 1 }` が返る
- **AND** LocalStorageに2件が新規追加される

#### Scenario: addDayOffs に空配列を渡した場合は何もしない

- **GIVEN** dates に空配列 `[]` を渡す
- **WHEN** `addDayOffs(staffId, [])` を呼ぶ
- **THEN** `{ added: 0, skipped: 0 }` が返る
- **AND** LocalStorageは変更されない
