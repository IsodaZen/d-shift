# auto-shift-generation Specification

## Purpose
TBD - created by archiving change auto-shift-creation. Update Purpose after archive.
## Requirements
### Requirement: シフト作成期間全体のシフト叩き台をワンクリックで自動生成できる
システムは、登録済みのシフト作成期間を対象に、全スタッフ・全日程のシフト割り当て叩き台を一括生成できなければならない（SHALL）。生成結果はLocalStorageに保存され、通常の手動アサインと同じデータ構造で扱われる。

#### Scenario: 自動生成を実行するとシフトが生成される
- **WHEN** ユーザーが「自動生成」ボタンを押し、確認ダイアログで実行を承認する
- **THEN** シフト作成期間内のすべての日付・時間帯に対して制約を満たすアサインが生成され、LocalStorageに保存される

---

### Requirement: 既存のアサインがある場合は上書き確認ダイアログを表示する
システムは、シフト作成期間内に既存のアサインが1件以上存在する場合、自動生成を実行する前に上書き確認ダイアログを表示しなければならない（SHALL）。ユーザーがキャンセルした場合は既存のアサインを保持する。

#### Scenario: 既存アサインがある場合は確認ダイアログが表示される
- **WHEN** シフト作成期間内に既存のアサインが存在する状態で「自動生成」ボタンを押す
- **THEN** 上書きの確認ダイアログが表示される

#### Scenario: 確認ダイアログでキャンセルすると既存アサインが保持される
- **WHEN** 上書き確認ダイアログで「キャンセル」を選択する
- **THEN** 自動生成は実行されず、既存のアサインはそのまま保持される

#### Scenario: 既存アサインがない場合は確認なく生成される
- **WHEN** シフト作成期間内にアサインが1件も存在しない状態で「自動生成」ボタンを押す
- **THEN** 確認ダイアログを表示せず、直ちに自動生成が実行される

---

### Requirement: 希望休の日にはアサインしない（強制制約）
システムは、自動生成時に希望休が登録されているスタッフ・日付の組み合わせへの割り当てを行ってはならない（SHALL NOT）。

#### Scenario: 希望休登録日にはアサインが生成されない
- **WHEN** スタッフAの特定の日に希望休が登録されている状態で自動生成を実行する
- **THEN** その日のスタッフAへのアサインは生成されない

---

### Requirement: スタッフの出勤可能時間帯のみに割り当てる（強制制約）
システムは、自動生成時にスタッフの出勤可能時間帯として登録されていない時間帯へのアサインを行ってはならない（SHALL NOT）。

#### Scenario: 出勤不可の時間帯にはアサインが生成されない
- **WHEN** スタッフBの出勤可能時間帯が「午前・午後」のみで登録されている状態で自動生成を実行する
- **THEN** スタッフBへの「夕方」のアサインは生成されない

---

### Requirement: 週上限出勤回数を超えない（強制制約）
システムは、自動生成時に各スタッフの週上限出勤回数（月曜〜日曜の7日間単位）を超えるアサインを生成してはならない（SHALL NOT）。同一日に複数の時間帯にアサインされる場合も1出勤としてカウントする。

#### Scenario: 週上限に達したスタッフにはそれ以上アサインが生成されない
- **WHEN** スタッフCの週上限が3回で、ある週にすでに3日分のアサインが生成された場合
- **THEN** その週のスタッフCへの追加アサインは生成されない

---

### Requirement: 駐車場が必要なスタッフは駐車場に空きがなければアサインしない（強制制約）
システムは、自動生成時に `usesParking=true` のスタッフを、駐車場に空き枠がない場合に出勤不可として扱い、アサインを生成してはならない（SHALL NOT）。`usesParking=false` のスタッフは駐車場の空き状況に関わらずアサイン対象となる（SHALL）。

#### Scenario: 駐車場が満杯のとき usesParking=true のスタッフはアサインされない
- **GIVEN** 駐車場の空き枠がすべて使用済みである
- **WHEN** 自動生成でスタッフの割り当てを決定する
- **THEN** `usesParking=true` のスタッフへのアサインは生成されない

#### Scenario: 駐車場が必要ないスタッフは駐車場の状況に関わらずアサインされる
- **GIVEN** 駐車場の空き枠がすべて使用済みである
- **WHEN** 自動生成でスタッフの割り当てを決定する
- **THEN** `usesParking=false` のスタッフは通常通りアサイン対象となる

#### Scenario: 同日に既に駐車場を確保済みのスタッフは再利用してアサインされる
- **GIVEN** `usesParking=true` のスタッフが同日の別時間帯にアサイン済みで駐車場枠を確保している
- **WHEN** 同日の別時間帯に追加でアサインを生成する
- **THEN** 既存の駐車場枠を再利用して同スタッフにアサインが生成される（新規枠を消費しない）

---

### Requirement: 出勤日には利用可能な全時間帯にアサインする（強制制約）

システムは、自動生成時にあるスタッフをある日に出勤させる場合、そのスタッフが出勤可能として登録されている**全ての時間帯**にアサインしなければならない（SHALL）。特定の時間帯のみにアサインし、他の利用可能時間帯をスキップすることは禁止する。

#### Scenario: 複数時間帯対応スタッフは全時間帯にアサインされる
- **GIVEN** スタッフAの出勤可能時間帯が「午前・午後」として登録されている
- **WHEN** 自動生成でスタッフAをある日に出勤させると決定する
- **THEN** スタッフAは午前と午後の両方にアサインされる（午後のみ・午前のみは禁止）

#### Scenario: 単一時間帯対応スタッフはその時間帯のみにアサインされる
- **GIVEN** スタッフBの出勤可能時間帯が「午前」のみとして登録されている
- **WHEN** 自動生成でスタッフBをある日に出勤させると決定する
- **THEN** スタッフBは午前のみにアサインされる

---

### Requirement: 各時間帯の必要人数を超えるアサインを禁止する（強制制約・例外あり）

システムは、自動生成時に各日・各時間帯のアサイン人数が必要人数（requiredCount）を超えないよう制御しなければならない（SHALL）。全時間帯が必要人数を満たしている場合、それ以上スタッフをアサインしてはならない（SHALL NOT）。

**例外**: いずれかの時間帯のスタッフが不足しており、「全時間帯出勤の原則」を適用することにより別の時間帯で必要人数を超える場合は、その超過を許容する（MAY）。その場合でも、超過人数が最小となるようスタッフ数を最小化しなければならない（SHALL）。

#### Scenario: 必要人数を超えてアサインしない（通常ケース）
- **GIVEN** ある日の午前の必要人数が2人、利用可能な候補スタッフが4人いる
- **WHEN** 自動生成を実行する
- **THEN** 午前にアサインされるスタッフは2人以下である（必要人数を超えない）

#### Scenario: 全時間帯が満たされたらそれ以上アサインしない
- **GIVEN** ある日の全時間帯が必要人数を満たしている
- **WHEN** まだアサインされていない候補スタッフが残っている
- **THEN** 追加のスタッフはアサインされない

#### Scenario: 全時間帯出勤の原則による超過は許容するが最小化する
- **GIVEN** 午前の必要人数が3人、午後の必要人数が1人
- **AND** 候補スタッフは全員「午前・午後」両方に対応可能
- **WHEN** 午前の必要人数（3人）を満たすために3人をアサインする
- **THEN** 午後に3人アサインされる（必要1人を超えるが、午前不足回避のために許容）
- **AND** 不要に4人目以降をアサインしない（超過を最小化）

---

### Requirement: 各日・各時間帯の必要人数を可能な限り満たす（ベストエフォート）
システムは、シフト枠設定で定義された各日・各時間帯の必要人数を達成するよう、制約の範囲内で最大限スタッフを割り当てなければならない（SHALL）。制約により必要人数を満たせない場合は達成できる範囲でアサインを生成し、不足の場合もエラーにはならない。

#### Scenario: 制約を満たしつつ必要人数分のアサインが生成される
- **WHEN** ある日の午前の必要人数が3人で、制約を満たす割り当て可能なスタッフが3人以上いる
- **THEN** その日の午前に3人がアサインされる

#### Scenario: スタッフ不足の場合は達成可能な人数でアサインが生成される
- **WHEN** ある日の午前の必要人数が3人だが、制約を満たす割り当て可能なスタッフが1人しかいない
- **THEN** 1人がアサインされ、エラーは発生しない

---

### Requirement: 自動生成後に必要人数を満たせなかった日時帯を通知する
システムは、自動生成完了後に必要人数を1人以上満たせなかった日付・時間帯の一覧をユーザーに提示しなければならない（SHALL）。必要人数をすべて満たせた場合は不足なしとして通知する。

#### Scenario: 不足がある場合は不足一覧が表示される
- **WHEN** 自動生成が完了し、必要人数を満たせなかった日付・時間帯が1件以上ある
- **THEN** 生成完了後に不足一覧（日付・時間帯・不足人数）が表示される

#### Scenario: すべての必要人数を満たせた場合は不足なしと通知される
- **WHEN** 自動生成が完了し、すべての日付・時間帯で必要人数が達成されている
- **THEN** 「必要人数をすべて満たしました」旨のメッセージが表示される

---

### Requirement: シフト表上で必要人数が不足している日付・時間帯を視覚的に識別できる
システムは、シフト作成期間内の各日・各時間帯について、アサイン人数が必要人数を下回っている場合にシフト表上で視覚的に区別できるよう表示しなければならない（SHALL）。この表示は自動生成後だけでなく手動アサイン後も常に反映される。

#### Scenario: 不足している時間帯がシフト表上でハイライトされる
- **WHEN** ある日の午前のアサイン人数が必要人数を下回っている
- **THEN** シフト表のその日の列に不足を示す視覚的インジケーター（例：不足人数バッジ・警告色）が表示される

#### Scenario: 必要人数を達成している時間帯はハイライトされない
- **WHEN** ある日の全時間帯でアサイン人数が必要人数以上である
- **THEN** その日の列に不足インジケーターは表示されない

---

### Requirement: ヘルプスタッフを自動生成の割り当て候補に含める

システムは、自動シフト生成時にヘルプスタッフを通常スタッフとともに割り当て候補として扱わなければならない（SHALL）。ただし、通常スタッフを優先的にアサインし、ヘルプスタッフのアサイン数が最小となるよう全体最適化しなければならない（SHALL）。

**最適化方針:**
- 候補スタッフのソート順: 通常スタッフ（週アサイン数の少ない順）→ ヘルプスタッフ（期間内アサイン数の少ない順）
- 通常スタッフだけで各時間帯の必要人数を充足できる場合、ヘルプスタッフはアサインしない
- 通常スタッフだけでは不足する場合にのみ、ヘルプスタッフを不足分だけアサインする

#### Scenario: 通常スタッフで充足可能な場合、ヘルプスタッフはアサインされない

- **GIVEN** ある日の午前の必要人数が2人
- **AND** 通常スタッフが3人利用可能である
- **AND** ヘルプスタッフが1人稼働可能である
- **WHEN** 自動生成を実行する
- **THEN** 通常スタッフのみがアサインされ、ヘルプスタッフはアサインされない

#### Scenario: 通常スタッフだけでは不足する場合、ヘルプスタッフがアサインされる

- **GIVEN** ある日の午前の必要人数が3人
- **AND** 通常スタッフが1人しか利用可能でない
- **AND** ヘルプスタッフが2人稼働可能である
- **WHEN** 自動生成を実行する
- **THEN** 通常スタッフ1人とヘルプスタッフ2人がアサインされる

#### Scenario: 複数ヘルプスタッフがいる場合、アサイン数の少ないヘルプスタッフが優先される

- **GIVEN** ヘルプスタッフAの期間内アサイン数が2日
- **AND** ヘルプスタッフBの期間内アサイン数が0日
- **WHEN** ヘルプスタッフを1人アサインする必要がある
- **THEN** ヘルプスタッフB（アサイン数0日）が優先的にアサインされる

---

### Requirement: ヘルプスタッフは稼働可能日付のみにアサインする（強制制約）

システムは、自動生成時にヘルプスタッフの `availableDates` に含まれない日付へのアサインを行ってはならない（SHALL NOT）。

#### Scenario: 稼働可能日付にはアサインされる

- **GIVEN** ヘルプスタッフAの `availableDates` に date1 が含まれている
- **WHEN** date1 の自動生成でヘルプスタッフAが候補になる
- **THEN** ヘルプスタッフAはdate1にアサイン可能である

#### Scenario: 稼働可能日付に含まれない日にはアサインされない

- **GIVEN** ヘルプスタッフAの `availableDates` に date2 が含まれていない
- **WHEN** date2 の自動生成でアサイン候補を決定する
- **THEN** ヘルプスタッフAはdate2のアサイン候補から除外される

---

### Requirement: ヘルプスタッフに既存の強制制約を適用する（一部除外）

システムは、ヘルプスタッフに対して以下の強制制約を適用しなければならない（SHALL）:

- **出勤可能時間帯制約**: `availableSlots` に含まれない時間帯にはアサインしない
- **駐車場制約**: `usesParking=true` の場合、駐車場に空きがなければアサインしない
- **全時間帯アサイン制約**: 出勤日には利用可能な全時間帯（必要人数>0）にアサインする
- **必要人数上限制約**: 各時間帯の必要人数を超えるアサインをしない（例外あり：全時間帯アサインにより超過が避けられない場合は許容）

以下の制約はヘルプスタッフには適用しない:
- **週上限出勤回数**: ヘルプスタッフは `availableDates` で出勤日を制御するため適用しない
- **希望休**: ヘルプスタッフは希望休エンティティを持たないため適用しない

#### Scenario: ヘルプスタッフの出勤可能時間帯のみにアサインされる

- **GIVEN** ヘルプスタッフAの出勤可能時間帯が「午前・午後」のみである
- **WHEN** 自動生成でヘルプスタッフAをアサインする
- **THEN** 午前と午後にアサインされ、夕方にはアサインされない

#### Scenario: ヘルプスタッフも出勤日には全時間帯にアサインされる

- **GIVEN** ヘルプスタッフAの出勤可能時間帯が「午前・午後」で、両方とも必要人数>0である
- **WHEN** 自動生成でヘルプスタッフAをある日に出勤させると決定する
- **THEN** ヘルプスタッフAは午前と午後の両方にアサインされる

#### Scenario: ヘルプスタッフには週上限を適用しない

- **GIVEN** ヘルプスタッフAの `availableDates` に同一週内の5日が含まれている
- **WHEN** 自動生成を実行し、5日すべてでヘルプスタッフAが必要である
- **THEN** ヘルプスタッフAは5日すべてにアサインされる（週上限による制限なし）

