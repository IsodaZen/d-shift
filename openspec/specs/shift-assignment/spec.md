# shift-assignment Specification

## Purpose
スタッフを特定の日付・時間帯にアサイン（割り当て）し、シフト表の割り当てを管理する機能。アサインはLocalStorageに永続化され、警告表示や駐車場の自動割り当てをサポートする。
## Requirements
### Requirement: スタッフを日付・時間帯に手動でアサインできる
システムは、ユーザーがスタッフを特定の日付・時間帯に手動でアサイン（割り当て）できなければならない（SHALL）。アサインはLocalStorageに永続化される。

#### Scenario: スタッフをシフトにアサインできる
- **WHEN** ユーザーがシフト表のセル（スタッフ×日付）から時間帯を選択してアサインする
- **THEN** アサインがLocalStorageに保存され、シフト表に反映される

#### Scenario: アサインを解除できる
- **WHEN** ユーザーが既存のアサインを解除する操作を行う
- **THEN** そのアサインがLocalStorageから削除され、シフト表からも消える

---

### Requirement: 週上限出勤回数を超えるアサインは警告を表示する
システムは、あるスタッフの週当たりのアサイン数がそのスタッフの週上限出勤回数を超えた場合、警告を表示しなければならない（SHALL）。ただし保存自体は行える。

#### Scenario: 週上限を超えた場合に警告が表示される
- **WHEN** スタッフの週アサイン数が週上限出勤回数を超えるアサインを行う
- **THEN** 「週上限を超えています」などの警告が表示されるが、アサインは保存される

---

### Requirement: 出勤不可時間帯へのアサインは警告を表示する
システムは、スタッフの出勤可能時間帯に含まれない時間帯にアサインしようとした場合、警告を表示しなければならない（SHALL）。ただし保存自体は行える。

#### Scenario: 出勤不可時間帯への割り当て時に警告が表示される
- **WHEN** スタッフが出勤不可と設定している時間帯にアサインを行う
- **THEN** 「この時間帯は出勤不可です」などの警告が表示されるが、アサインは保存される

---

### Requirement: 希望休日へのアサインをハイライト表示する
システムは、希望休が登録されている日にアサインされているスタッフのセルを視覚的に区別できなければならない（SHALL）。

#### Scenario: 希望休日のアサインが強調表示される
- **WHEN** 希望休が登録されている日にそのスタッフがアサインされている
- **THEN** シフト表のそのセルが希望休アサインを示す色（例：赤）でハイライト表示される

---

### Requirement: 駐車場をアサイン時に自動割り当てする（時間帯ベース）
システムは、駐車場利用フラグがONのスタッフがアサインされた際、以下の優先順位で駐車場枠を割り当てなければならない（SHALL）。

1. 同一スタッフが同一日にすでに駐車場枠が割り当てられているアサインが存在する場合、その既存の枠を再利用する（時間帯にかかわらず）
2. 既存の割り当てがない場合、**同一日・同一時間帯**に他スタッフが使用していない空き枠を、種別A優先・同種別内では番号昇順（A1, A2, ...）で新規割り当てする
3. 空き枠がない場合は割り当てなしとする

時間帯とは「午前（morning）・午後（afternoon）・夕方（evening）」の3区分を指す（`shift-slot-config` 仕様に準拠）。異なる時間帯のスタッフ間では同一の駐車場枠を共有できる。

バルクアサイン（自動生成によるアサイン一括適用）においても、同一のロジック（時間帯ベースの空き枠チェックおよび同一スタッフ同一日の既存枠再利用）を適用する。

#### Scenario: AMのみのスタッフとPMのみのスタッフが同一枠を共有できる
- **GIVEN** 駐車場利用フラグがONのスタッフAが午前にアサインされており、枠A1が割り当てられている
- **WHEN** 駐車場利用フラグがONの別スタッフBを同一日の午後にアサインする
- **THEN** スタッフBにも枠A1が割り当てられる（午後の時間帯にA1を使用するスタッフがいないため）

#### Scenario: 同一時間帯にすでに枠が使用されている場合は別の枠が割り当てられる
- **GIVEN** 駐車場利用フラグがONのスタッフAが午前にアサインされており、枠A1が割り当てられている
- **WHEN** 駐車場利用フラグがONの別スタッフBを同一日の午前にアサインしようとする
- **THEN** スタッフBにはA1ではなくA2（次の空き枠）が割り当てられる

#### Scenario: 夕方のスタッフと午前のスタッフが同一枠を共有できる
- **GIVEN** 駐車場利用フラグがONのスタッフAが午前にアサインされており、枠A1が割り当てられている
- **WHEN** 駐車場利用フラグがONの別スタッフBを同一日の夕方にアサインする
- **THEN** スタッフBにも枠A1が割り当てられる（夕方の時間帯にA1を使用するスタッフがいないため）

#### Scenario: 駐車場枠が空いている場合に自動割り当てされる
- **GIVEN** 同一日・同一時間帯にアサイン済みのスタッフが存在しない（A1〜A4・B1がすべて空き）
- **WHEN** 駐車場利用フラグがONのスタッフをアサインする
- **THEN** 同一日・同一時間帯に空いている駐車場枠（A優先、次にB）が自動的に割り当てられる

#### Scenario: 同一時間帯の全枠が満杯の場合は割り当てなしになる
- **GIVEN** A1・A2・A3・A4・B1がすべて同一日・同一時間帯の別スタッフに割り当て済みである
- **WHEN** 駐車場利用フラグがONの別スタッフを同一日・同一時間帯にアサインしようとする
- **THEN** 駐車場番号なしでアサインが保存される

#### Scenario: 同一スタッフが同一日に複数時間帯でアサインされる場合は既存枠を再利用する
- **GIVEN** 駐車場利用フラグがONのスタッフAが午前にアサインされており、枠A1が割り当てられている（午後の時間帯には別スタッフがA1を使用中であっても）
- **WHEN** 同一スタッフAをさらに午後にアサインする
- **THEN** 新たに駐車場枠を消費せず、既存のアサインと同じ枠A1が割り当てられる（同一スタッフの連続利用のため競合は発生しない）

### Requirement: 自動生成によるバルクアサインを適用できる
システムは、自動生成アルゴリズムが出力したシフト叩き台（複数スタッフ×複数日×複数時間帯のアサインセット）を一括でLocalStorageに保存できなければならない（SHALL）。バルクアサイン後も個別アサイン操作はすべて継続して使用できる。

#### Scenario: バルクアサインが既存アサインなしの状態で適用される
- **WHEN** シフト作成期間内にアサインが存在しない状態で自動生成を実行する
- **THEN** 生成されたすべてのアサインが確認なしにLocalStorageへ保存され、シフト表に反映される

#### Scenario: バルクアサインが既存アサインありの状態で適用される
- **WHEN** シフト作成期間内に既存のアサインが存在する状態で自動生成を実行する
- **THEN** 上書き確認ダイアログが表示され、ユーザーが「上書き」を選択した場合のみ、期間内の既存アサインをすべて削除したうえで新しいアサインが保存される

#### Scenario: 上書き確認ダイアログでキャンセルした場合はアサインが変わらない
- **WHEN** 既存アサインがある状態で上書き確認ダイアログが表示され、ユーザーが「キャンセル」を選択する
- **THEN** 既存のアサインは一切変更されず、自動生成結果は適用されない

---

### Requirement: バルクアサインのデータ形式は個別アサインと同一である
システムは、バルクアサインによって保存されるデータを、手動による個別アサインと同一の形式でLocalStorageに保存しなければならない（SHALL）。これにより、バルクアサイン後に個別アサインの追加・変更・削除がそのまま行える。

#### Scenario: バルクアサイン後に個別アサインを編集できる
- **WHEN** 自動生成によるバルクアサインが適用された後にユーザーが特定のセルのアサインを手動で変更する
- **THEN** そのセルのアサインが変更され、他のセルのアサインは影響を受けない

